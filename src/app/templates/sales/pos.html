{% extends "base.html" %} {% block title %}{{ page_title }}{% endblock %} {%
block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Product Search and Cart Section -->
    <div class="col-lg-8">
      <!-- Product Search -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Product Search</h5>
        </div>
        <div class="card-body">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              id="product-search"
              placeholder="Search by name, SKU, or barcode..."
              hx-get="/pos/products/search"
              hx-trigger="keyup changed delay:300ms"
              hx-target="#search-results"
              hx-indicator="#search-spinner"
            />
            <span class="input-group-text">
              <i class="bi bi-search"></i>
              <span
                id="search-spinner"
                class="spinner-border spinner-border-sm ms-2 htmx-indicator"
                role="status"
              >
                <span class="visually-hidden">Searching...</span>
              </span>
            </span>
          </div>
          <div id="search-results" class="mt-3"></div>
        </div>
      </div>

      <!-- Shopping Cart -->
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Shopping Cart</h5>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            onclick="clearCart()"
          >
            <i class="bi bi-trash"></i> Clear Cart
          </button>
        </div>
        <div class="card-body">
          <form id="checkout-form" hx-post="/pos/checkout">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="cart-items">
                  <!-- Cart items will be inserted here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3" class="text-end">
                      <strong>Subtotal:</strong>
                    </td>
                    <td><strong id="cart-subtotal">$0.00</strong></td>
                    <td></td>
                  </tr>
                  <tr>
                    <td colspan="3" class="text-end">
                      <strong>Discount:</strong>
                    </td>
                    <td>
                      <input
                        type="number"
                        name="discount_amount"
                        class="form-control form-control-sm"
                        value="0"
                        min="0"
                        step="0.01"
                        onchange="updateTotals()"
                      />
                    </td>
                    <td></td>
                  </tr>
                  <tr>
                    <td colspan="3" class="text-end"><strong>Tax:</strong></td>
                    <td><strong id="cart-tax">$0.00</strong></td>
                    <td></td>
                  </tr>
                  <tr class="table-primary">
                    <td colspan="3" class="text-end"><h5>Total:</h5></td>
                    <td><h5 id="cart-total">$0.00</h5></td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Customer and Payment Section -->
            <div class="row mt-4">
              <div class="col-md-6">
                <label for="customer_id" class="form-label">Customer</label>
                <select name="customer_id" id="customer_id" class="form-select">
                  <option value="">Walk-in Customer</option>
                  <!-- Customer options would be loaded here -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="payment_method" class="form-label"
                  >Payment Method</label
                >
                <select
                  name="payment_method"
                  id="payment_method"
                  class="form-select"
                  required
                >
                  <option value="cash">Cash</option>
                  <option value="credit">Credit</option>
                  <option value="transfer">Transfer</option>
                  <option value="mixed">Mixed</option>
                </select>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-12">
                <label for="notes" class="form-label">Notes</label>
                <textarea
                  name="notes"
                  id="notes"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-12 text-end">
                <button
                  type="submit"
                  class="btn btn-primary btn-lg"
                  id="checkout-btn"
                  disabled
                >
                  <i class="bi bi-check-circle"></i> Complete Sale
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Quick Actions and Info -->
    <div class="col-lg-4">
      <!-- Quick Product Buttons -->
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Quick Products</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">
            Quick product buttons will be added in a future update
          </p>
        </div>
      </div>

      <!-- Sale Info -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Sale Information</h5>
        </div>
        <div class="card-body">
          <p><strong>Date:</strong> {{ current_date }}</p>
          <p><strong>Cashier:</strong> {{ current_user.full_name }}</p>
          <p><strong>Terminal:</strong> POS-01</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let cartItemIndex = 0;

  function addToCart(productId, productName, productSku, price, maxStock) {
    // Check if product already in cart
    const existingItem = document.querySelector(
      `input[name^="product_id_"][value="${productId}"]`,
    );
    if (existingItem) {
      // Update quantity of existing item
      const quantityInput = existingItem
        .closest("tr")
        .querySelector('input[name^="quantity_"]');
      const currentQty = parseInt(quantityInput.value);
      if (currentQty < maxStock) {
        quantityInput.value = currentQty + 1;
        updateItemTotal(quantityInput);
      } else {
        alert(`Maximum stock available: ${maxStock}`);
      }
      return;
    }

    // Add new item to cart
    const tbody = document.getElementById("cart-items");
    const row = tbody.insertRow();
    row.innerHTML = `
        <td>
            <input type="hidden" name="product_id_${cartItemIndex}" value="${productId}">
            <strong>${productSku}</strong><br>
            <small>${productName}</small>
        </td>
        <td>
            <input type="number"
                   name="quantity_${cartItemIndex}"
                   class="form-control form-control-sm"
                   value="1"
                   min="1"
                   max="${maxStock}"
                   onchange="updateItemTotal(this)">
        </td>
        <td>
            <input type="number"
                   name="unit_price_${cartItemIndex}"
                   class="form-control form-control-sm"
                   value="${price}"
                   step="0.01"
                   onchange="updateItemTotal(this)">
        </td>
        <td class="item-total">$${price.toFixed(2)}</td>
        <td>
            <button type="button"
                    class="btn btn-sm btn-danger"
                    onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;

    cartItemIndex++;
    updateTotals();
    document.getElementById("checkout-btn").disabled = false;
  }

  function removeItem(button) {
    button.closest("tr").remove();
    updateTotals();

    // Disable checkout if cart is empty
    if (document.getElementById("cart-items").rows.length === 0) {
      document.getElementById("checkout-btn").disabled = true;
    }
  }

  function updateItemTotal(input) {
    const row = input.closest("tr");
    const quantity =
      parseFloat(row.querySelector('input[name^="quantity_"]').value) || 0;
    const price =
      parseFloat(row.querySelector('input[name^="unit_price_"]').value) || 0;
    const total = quantity * price;

    row.querySelector(".item-total").textContent = `$${total.toFixed(2)}`;
    updateTotals();
  }

  function updateTotals() {
    let subtotal = 0;

    // Calculate subtotal
    document.querySelectorAll(".item-total").forEach((cell) => {
      const value = parseFloat(cell.textContent.replace("$", "")) || 0;
      subtotal += value;
    });

    // Get discount
    const discount =
      parseFloat(
        document.querySelector('input[name="discount_amount"]').value,
      ) || 0;

    // Calculate tax (16% default)
    const taxRate = 0.16;
    const taxableAmount = subtotal - discount;
    const tax = taxableAmount * taxRate;

    // Calculate total
    const total = taxableAmount + tax;

    // Update display
    document.getElementById("cart-subtotal").textContent = `$${subtotal.toFixed(
      2,
    )}`;
    document.getElementById("cart-tax").textContent = `$${tax.toFixed(2)}`;
    document.getElementById("cart-total").textContent = `$${total.toFixed(2)}`;
  }

  function clearCart() {
    if (confirm("Are you sure you want to clear the cart?")) {
      document.getElementById("cart-items").innerHTML = "";
      updateTotals();
      document.getElementById("checkout-btn").disabled = true;
    }
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", function () {
    // Set current date
    const dateElement = document.querySelector('p:contains("Date:")');
    if (dateElement) {
      const now = new Date();
      dateElement.innerHTML = `<strong>Date:</strong> ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }
  });
</script>
{% endblock %}
