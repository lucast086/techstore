{% extends "base.html" %} {% block title %}{{ page_title }}{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-900">
      Sale Details - {{ sale.invoice_number }}
    </h1>
    <div class="space-x-2">
      <a href="/sales" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Volver a Ventas
      </a>
      <a href="/sales/{{ sale.id }}/receipt" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Imprimir Recibo
      </a>
      <a href="/sales/{{ sale.id }}/invoice/download" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
        </svg>
        Descargar Factura
      </a>
    </div>
  </div>

  <!-- Sale Estado Alert -->
  {% if sale.is_voided %}
  <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
    <div class="flex">
      <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
      </svg>
      <div>
        <h4 class="font-semibold">Esta venta ha sido anulada</h4>
        <p class="text-sm mt-1">Razón: {{ sale.void_reason }}</p>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Sale Information -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Información de Venta</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm font-medium text-gray-500">Número de Factura</p>
              <p class="mt-1 text-gray-900">{{ sale.invoice_number }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Fecha</p>
              <p class="mt-1 text-gray-900">{{ sale.sale_date.strftime('%Y-%m-%d %H:%M') }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Cliente:</p>
              <p class="mt-1 text-gray-900">
                {% if sale.customer %}
                  {{ sale.customer.name }}
                {% else %}
                  Cliente de Mostrador
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Cajero:</p>
              <p class="mt-1 text-gray-900">{{ sale.user.full_name }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Método de Pago:</p>
              <p class="mt-1 text-gray-900">{{ sale.payment_method|capitalize }}</p>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-500">Estado de Pago:</p>
              <p class="mt-1">
                {% if sale.payment_status == 'paid' %}
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    Pagado
                  </span>
                {% elif sale.payment_status == 'partial' %}
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                    Parcial
                  </span>
                {% elif sale.payment_status == 'pending' %}
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                    Pendiente
                  </span>
                {% else %}
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                    {{ sale.payment_status|capitalize }}
                  </span>
                {% endif %}
              </p>
            </div>
          </div>
          {% if sale.notes %}
          <div class="mt-4">
            <p class="text-sm font-medium text-gray-500">Notas</p>
            <p class="mt-1 text-gray-900">{{ sale.notes }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Payment History -->
      {% if sale.payments %}
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Historial de Pagos</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Fecha
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Recibo
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Método
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Referencia
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Monto
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estado
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for payment in sale.payments %}
              <tr class="{% if payment.voided %}opacity-50 line-through{% endif %}">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <a href="/payments/{{ payment.id }}" class="text-sm text-primary-600 hover:text-primary-800">
                    {{ payment.receipt_number }}
                  </a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ payment.payment_method|capitalize }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ payment.reference_number or '-' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                  ${{ payment.amount }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  {% if payment.voided %}
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                      Anulado
                    </span>
                  {% else %}
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                      Válido
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Sale Items -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Items de Venta</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Producto
                </th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Cantidad
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Precio Unitario
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Descuento
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Total
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for item in sale.items %}
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm">
                    <div class="font-medium text-gray-900">{{ item.product.name }}</div>
                    <div class="text-gray-500">{{ item.product.sku }}</div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900">
                  {{ item.quantity }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  ${{ item.unit_price }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                  {% if item.discount_percentage > 0 or item.discount_amount > 0 %}
                    {% if item.discount_percentage > 0 %}
                      {{ item.discount_percentage }}%
                    {% endif %}
                    {% if item.discount_amount > 0 %}
                      ${{ item.discount_amount }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">
                  ${{ item.total_price }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-gray-50">
              <tr>
                <td colspan="4" class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  Subtotal:
                </td>
                <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  ${{ sale.subtotal }}
                </td>
              </tr>
              {% if sale.discount_amount > 0 %}
              <tr>
                <td colspan="4" class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  Descuento:
                </td>
                <td class="px-6 py-3 text-right text-sm font-medium text-red-600">
                  -${{ sale.discount_amount }}
                </td>
              </tr>
              {% endif %}
              <tr>
                <td colspan="4" class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  Impuesto:
                </td>
                <td class="px-6 py-3 text-right text-sm font-medium text-gray-900">
                  ${{ sale.tax_amount }}
                </td>
              </tr>
              <tr class="bg-primary-50">
                <td colspan="4" class="px-6 py-3 text-right text-lg font-semibold text-gray-900">
                  Total:
                </td>
                <td class="px-6 py-3 text-right text-lg font-semibold text-primary-600">
                  ${{ sale.total_amount }}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Payment Information -->
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Información de Pago</h2>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <p class="text-sm font-medium text-gray-500">Monto Total</p>
            <p class="mt-1 text-2xl font-semibold text-gray-900">${{ sale.total_amount }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Monto Pagado</p>
            <p class="mt-1 text-xl font-semibold text-green-600">${{ sale.amount_paid }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Monto Pendiente</p>
            <p class="mt-1 text-xl font-semibold {% if sale.amount_due > 0 %}text-red-600{% else %}text-gray-500{% endif %}">
              ${{ sale.amount_due }}
            </p>
          </div>
        </div>
      </div>

      <!-- Actions -->
      {% if not sale.is_voided %}
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Acciones</h2>
        </div>
        <div class="p-6 space-y-3">
          {% if sale.payment_status != 'paid' and sale.customer_id %}
          <button type="button" onclick="showPaymentModal()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Agregar Pago
          </button>
          {% endif %}

          {% if current_user.is_admin %}
          <button type="button" onclick="showVoidModal()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
            <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
            </svg>
            Anular Venta
          </button>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Agregar Pago</h3>
      <form hx-post="/sales/{{ sale.id }}/add-payment" hx-target="#payment-result" hx-swap="innerHTML">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Monto Pendiente: <span class="text-lg font-semibold text-red-600">${{ sale.amount_due }}</span>
          </label>
        </div>

        <div class="mb-4">
          <label for="payment_amount" class="block text-sm font-medium text-gray-700 mb-2">
            Monto a Pagar
          </label>
          <input
            type="number"
            id="payment_amount"
            name="amount"
            step="0.01"
            min="0.01"
            max="{{ sale.amount_due }}"
            value="{{ sale.amount_due }}"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            required
          />
        </div>

        <div class="mb-4">
          <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-2">
            Método de Pago
          </label>
          <select
            id="payment_method"
            name="payment_method"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            required
            onchange="toggleReferenceField()"
          >
            <option value="cash">Efectivo</option>
            <option value="transfer">Transferencia</option>
            <option value="card">Tarjeta</option>
          </select>
        </div>

        <div id="reference_field" class="mb-4 hidden">
          <label for="reference_number" class="block text-sm font-medium text-gray-700 mb-2">
            Número de Referencia
          </label>
          <input
            type="text"
            id="reference_number"
            name="reference_number"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          />
        </div>

        <div class="mb-4">
          <label for="payment_notes" class="block text-sm font-medium text-gray-700 mb-2">
            Notas (opcional)
          </label>
          <textarea
            id="payment_notes"
            name="notes"
            rows="2"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          ></textarea>
        </div>

        <div id="payment-result"></div>

        <div class="flex justify-end space-x-3">
          <button type="button" onclick="hidePaymentModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            Cancelar
          </button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            Procesar Pago
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Void Modal -->
<div id="voidModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Anular Venta</h3>
      <form hx-post="/sales/{{ sale.id }}/void" hx-target="#void-result">
        <div class="mb-4">
          <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
            Razón para anular (mínimo 10 caracteres)
          </label>
          <textarea
            id="reason"
            name="reason"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            required
            minlength="10"
          ></textarea>
        </div>
        <div id="void-result"></div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="hideVoidModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
            Cancelar
          </button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
            Anular Venta
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function showPaymentModal() {
  document.getElementById('paymentModal').classList.remove('hidden');
}

function hidePaymentModal() {
  document.getElementById('paymentModal').classList.add('hidden');
}

function toggleReferenceField() {
  const method = document.getElementById('payment_method').value;
  const referenceField = document.getElementById('reference_field');
  const referenceInput = document.getElementById('reference_number');

  if (method === 'transfer' || method === 'card') {
    referenceField.classList.remove('hidden');
    referenceInput.setAttribute('required', 'required');
  } else {
    referenceField.classList.add('hidden');
    referenceInput.removeAttribute('required');
    referenceInput.value = '';
  }
}

function showVoidModal() {
  document.getElementById('voidModal').classList.remove('hidden');
}

function hideVoidModal() {
  document.getElementById('voidModal').classList.add('hidden');
}

// Cerrar modals when clicking outside
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hidePaymentModal();
  }
});

document.getElementById('voidModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideVoidModal();
  }
});
</script>
{% endblock %}
