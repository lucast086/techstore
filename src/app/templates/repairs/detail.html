{% extends "base.html" %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ repair.repair_number }}</h1>
            <p class="text-gray-600 mt-1">
                Cliente: <a href="/customers/{{ repair.customer_id }}" class="text-primary-600 hover:text-primary-700">
                    {{ repair.customer_name }}
                </a>
            </p>
        </div>
        <div class="flex items-center space-x-3">
            {% set status_colors = {
                'received': 'bg-gray-100 text-gray-800',
                'diagnosing': 'bg-blue-100 text-blue-800',
                'approved': 'bg-green-100 text-green-800',
                'repairing': 'bg-yellow-100 text-yellow-800',
                'testing': 'bg-purple-100 text-purple-800',
                'ready': 'bg-green-100 text-green-800',
                'delivered': 'bg-gray-100 text-gray-800',
                'cancelled': 'bg-red-100 text-red-800'
            } %}
            <div id="status-badge">
                <span class="px-3 py-1 text-sm font-medium rounded-full {{ status_colors.get(repair.status, 'bg-gray-100 text-gray-800') }}">
                    {{ repair.status.replace('_', ' ').title() }}
                </span>
            </div>
            {% if repair.is_express %}
            <span class="px-3 py-1 text-sm font-medium bg-yellow-100 text-yellow-800 rounded-full">
                Express
            </span>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Device Information -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Información del Dispositivo</h2>
                <dl class="grid grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Type</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.device_type.title() }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Brand</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.device_brand }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Model</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.device_model or '-' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Serial Number</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.serial_number or '-' }}</dd>
                    </div>
                </dl>
            </div>

            <!-- Problem Description -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Problem Description</h2>
                <p class="text-gray-700 whitespace-pre-wrap">{{ repair.problem_description }}</p>

                {% if repair.device_condition %}
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-500">Physical Condition</h3>
                    <p class="mt-1 text-sm text-gray-700">{{ repair.device_condition }}</p>
                </div>
                {% endif %}

                {% if repair.accessories_received %}
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-500">Accessories Received</h3>
                    <p class="mt-1 text-sm text-gray-700">{{ repair.accessories_received }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Diagnosis -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Diagnóstico</h2>
                    {% if repair.status not in ['ready', 'delivered', 'cancelled'] %}
                    <button onclick="showDiagnosisForm()"
                            class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                        {% if repair.diagnosis_notes %}Editar{% else %}Agregar{% endif %} Diagnóstico
                    </button>
                    {% if repair.customer_approved and repair.diagnosis_notes %}
                    <p class="text-xs text-amber-600 mt-1">⚠️ Editar revertirá la aprobación del cliente</p>
                    {% endif %}
                    {% endif %}
                </div>

                <div id="diagnosis-content">
                    {% if repair.diagnosis_notes %}
                    <div class="prose max-w-none">
                        <p class="font-semibold">Diagnóstico:</p>
                        <p>{{ repair.diagnosis_notes }}</p>
                        {% if repair.estimated_cost %}
                        <p class="mt-2">
                            <span class="font-semibold">Costo Estimado:</span>
                            ${{ "%.2f"|format(repair.estimated_cost) }}
                            {% if repair.labor_cost or repair.parts_cost %}
                            (Mano de obra: ${{ "%.2f"|format(repair.labor_cost or 0) }}, Repuestos: ${{ "%.2f"|format(repair.parts_cost or 0) }})
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-sm">Aún no se ha agregado diagnóstico</p>
                    {% endif %}
                </div>
            </div>

            <!-- Parts Used -->
            {% if repair.parts %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Repuestos Utilizados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Repuesto</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Cant</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Costo</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for part in repair.parts %}
                            <tr>
                                <td class="px-3 py-2 text-sm">{{ part.part_name }}</td>
                                <td class="px-3 py-2 text-sm text-center">{{ part.quantity }}</td>
                                <td class="px-3 py-2 text-sm text-right">${{ part.part_cost }}</td>
                                <td class="px-3 py-2 text-sm text-right font-medium">
                                    ${{ "%.2f"|format(part.part_cost * part.quantity) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Cost Breakdown -->
            {% if repair.estimated_cost or repair.final_cost %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Desglose de Costos</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="text-gray-600">Costo de Mano de Obra:</span>
                        <span class="font-medium">${{ "%.2f"|format(repair.labor_cost or 0) }}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="text-gray-600">Costo de Repuestos:</span>
                        <span class="font-medium">${{ "%.2f"|format(repair.parts_cost or 0) }}</span>
                    </div>
                    {% if repair.estimated_cost %}
                    <div class="flex justify-between items-center py-2 text-lg">
                        <span class="font-semibold text-gray-700">Total Estimado:</span>
                        <span class="font-bold text-primary-600">${{ "%.2f"|format(repair.estimated_cost) }}</span>
                    </div>
                    {% endif %}
                    {% if repair.final_cost %}
                    <div class="flex justify-between items-center py-2 text-lg border-t pt-3">
                        <span class="font-semibold text-gray-700">Total Final:</span>
                        <span class="font-bold text-green-600">${{ "%.2f"|format(repair.final_cost) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Status History -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Historial de Estado</h2>
                <div class="space-y-3">
                    {% for history in repair.status_history|reverse %}
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="h-8 w-8 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">
                                {{ history.status.replace('_', ' ').title() }}
                            </p>
                            {% if history.notes %}
                            <p class="text-sm text-gray-600 mt-1">{{ history.notes }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">
                                {{ history.created_at | local_datetime }}
                                {% if history.user_name %}
                                por {{ history.user_name }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Acciones</h2>

                <!-- Error message area -->
                <div id="status-error-message"></div>

                <!-- Sale Invoice Info -->
                {% if repair.sale_id %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-green-800">
                        <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Facturado en venta #{{ repair.sale_id }}
                    </p>
                </div>
                {% endif %}

                <!-- Actualizar Estado -->
                {% if repair.status not in ['delivered', 'cancelled'] %}
                <form hx-post="/repairs/{{ repair.id }}/status"
                      hx-target="#status-badge"
                      hx-target-error="#status-error-message"
                      hx-swap="outerHTML"
                      class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Actualizar Estado</label>
                    <select name="status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mb-2">
                        {% if repair.status == 'received' %}
                        <option value="diagnosing">Iniciar Diagnóstico</option>
                        <option value="cancelled">Cancelar</option>
                        {% elif repair.status == 'diagnosing' %}
                        <option value="approved">Cliente Aprobó</option>
                        <option value="ready">Listo (Express)</option>
                        <option value="cancelled">Cancelar</option>
                        {% elif repair.status == 'approved' %}
                        <option value="repairing">Iniciar Reparación</option>
                        <option value="cancelled">Cancelar</option>
                        {% elif repair.status == 'repairing' %}
                        <option value="testing">Iniciar Pruebas</option>
                        <option value="ready">Marcar como Listo</option>
                        <option value="cancelled">Cancelar</option>
                        {% elif repair.status == 'testing' %}
                        <option value="ready">Completar</option>
                        <option value="repairing">Volver a Reparación</option>
                        <option value="cancelled">Cancelar</option>
                        {% elif repair.status == 'ready' %}
                        <option value="delivered">Marcar como Entregado</option>
                        {% endif %}
                    </select>
                    <input type="text"
                           name="notes"
                           placeholder="Notas opcionales..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 mb-2">
                    <button type="submit"
                            class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg">
                        Actualizar Estado
                    </button>
                </form>
                {% endif %}

                <!-- Imprimir Recibo -->
                <a href="/repairs/{{ repair.id }}/receipt"
                   target="_blank"
                   class="block w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg">
                    Imprimir Recibo
                </a>
            </div>

            <!-- Repair Details -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Detalles</h2>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Fecha de Recepción</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.received_date | local_datetime }}</dd>
                    </div>
                    {% if repair.estimated_completion %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Finalización Estimada</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.estimated_completion | local_date }}</dd>
                    </div>
                    {% endif %}
                    {% if repair.completed_date %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Fecha de Finalización</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.completed_date | local_datetime }}</dd>
                    </div>
                    {% endif %}
                    {% if repair.delivered_date %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Fecha de Entrega</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.delivered_date | local_datetime }}</dd>
                    </div>
                    {% endif %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Garantía</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ repair.warranty_days }} días
                            {% if repair.warranty_expires %}
                            <span class="text-xs text-gray-500">(vence {{ repair.warranty_expires | local_date }})</span>
                            {% endif %}
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- Cost Summary -->
            {% if repair.estimated_cost or repair.final_cost %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Cost Summary</h2>
                <dl class="space-y-3">
                    {% if repair.estimated_cost %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Estimated Cost</dt>
                        <dd class="mt-1 text-lg font-medium text-gray-900">${{ repair.estimated_cost }}</dd>
                    </div>
                    {% endif %}
                    {% if repair.final_cost %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Final Cost</dt>
                        <dd class="mt-1 text-lg font-medium text-green-600">${{ repair.final_cost }}</dd>
                    </div>
                    {% endif %}
                    {% if repair.amount_due %}
                    <div class="pt-3 border-t">
                        <dt class="text-sm font-medium text-gray-500">Amount Due</dt>
                        <dd class="mt-1 text-lg font-bold text-red-600">${{ repair.amount_due }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
            {% endif %}

            <!-- Personnel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Personnel</h2>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Received By</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.receiver_name or '-' }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Technician</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.technician_name or 'Not assigned' }}</dd>
                    </div>
                    {% if repair.delivered_by %}
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Delivered By</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ repair.deliverer_name }}</dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Diagnosis Modal -->
<div id="diagnosis-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4" id="diagnosis-form-container">
        <!-- Form will be loaded here -->
    </div>
</div>

<script>
function showDiagnosisForm() {
    // Load diagnosis form via HTMX
    document.getElementById('diagnosis-form-container').innerHTML = 'Loading...';
    document.getElementById('diagnosis-modal').classList.remove('hidden');

    fetch('/repairs/{{ repair.id }}/diagnosis')
        .then(response => response.text())
        .then(html => {
            document.getElementById('diagnosis-form-container').innerHTML = html;
            // Process HTMX on the new content
            htmx.process(document.getElementById('diagnosis-form-container'));

            // Execute any script tags in the loaded content
            const scripts = document.getElementById('diagnosis-form-container').getElementsByTagName('script');
            for (let script of scripts) {
                eval(script.innerHTML);
            }

            // Initialize the form if the function exists
            if (typeof initializeRepairDiagnosisForm === 'function') {
                initializeRepairDiagnosisForm();
            }
        });
}

function closeDiagnosisModal() {
    document.getElementById('diagnosis-modal').classList.add('hidden');
}

// Close modal on outside click
document.getElementById('diagnosis-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDiagnosisModal();
    }
});

// Handle HTMX errors for status updates
document.body.addEventListener('htmx:responseError', function(evt) {
    // Check if this is from the status update form
    if (evt.detail.xhr.status === 400 && evt.detail.target && evt.detail.target.id === 'status-badge') {
        // Display the error message in the error area
        const errorContainer = document.getElementById('status-error-message');
        if (errorContainer) {
            errorContainer.innerHTML = evt.detail.xhr.responseText;
            // Auto-hide the error message after 10 seconds
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 10000);
        }
    }
});

// Clear error messages on successful requests
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        const errorContainer = document.getElementById('status-error-message');
        if (errorContainer) {
            errorContainer.innerHTML = '';
        }
    }
});
</script>
{% endblock %}
